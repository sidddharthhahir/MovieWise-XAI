# MovieWise XAI - Personalized Movie Recommendations with Explainable AI

MovieWise XAI is a Django-based web application that provides personalized movie recommendations to users, enhanced with explainable AI (XAI) features and a rich, interactive user interface. The system leverages state-of-the-art machine learning models (LightFM) and a local large language model (LLM, e.g. Llama 3 via Ollama) to deliver a seamless and insightful movie discovery experience.

## Table of Contents

1.  [Features](#1-features)  
2.  [Technology Stack](#2-technology-stack)  
3.  [Project Structure](#3-project-structure)  
4.  [Setup and Installation](#4-setup-and-installation)  
    *   [Prerequisites](#prerequisites)  
    *   [Python & Virtualenv Setup (Recommended)](#python--virtualenv-setup-recommended)  
5.  [Configuration](#5-configuration)  
6.  [Development Workflow](#6-development-workflow)  
    *   [Running the Server](#running-the-server)  
    *   [Database Migrations](#database-migrations)  
    *   [Creating a Superuser](#creating-a-superuser)  
    *   [Data Ingestion (TMDB)](#data-ingestion-tmdb)  
    *   [Training Recommendation Model](#training-recommendation-model)  
7.  [Key API Endpoints](#7-key-api-endpoints)  
8.  [User Flows](#8-user-flows)  
    *   [User Onboarding](#user-onboarding)  
    *   [Personalized Recommendations](#personalized-recommendations)  
    *   [Movie Rating](#movie-rating)  
    *   [Movie Search](#movie-search)  
    *   [Trailer Access](#trailer-access)  
    *   [Explainable AI](#explainable-ai)  
9.  [Frontend Details](#9-frontend-details)  
10. [Backend Details](#10-backend-details)  
11. [Explainable AI (XAI) Details](#11-explainable-ai-xai-details)  
12. [Troubleshooting](#12-troubleshooting)  

---

## 1. Features

* **Personalized Recommendations:** Get movie suggestions tailored to your unique taste using a LightFM-based hybrid collaborative filtering model.  
* **Explainable AI (XAI):** Understand *why* a movie is recommended with concise, natural language explanations generated by a local LLM (via Ollama) plus RAG.  
* **Real-time Trending:** Discover the latest popular movies directly from TMDB's dynamic feeds.  
* **Interactive Rating System:** Rate any movie with a 5-star system, providing instant feedback and influencing future recommendations.  
* **Guided Onboarding:** Smooth onboarding flow to quickly establish user preferences and unlock personalized content.  
* **Robust Search & Discovery:** Find movies by actor, genre, or language, powered by TMDB.  
* **Trailer Access:** Easily access movie trailers via YouTube search.  
* **User Authentication:** Secure user registration and login.  
* **Dark/Light Mode:** Seamlessly switch between themes for comfortable viewing.

---

## 2. Technology Stack

* **Backend:** Python 3.10.14, Django 5.x, Django REST Framework  
* **Frontend:** HTML5, CSS3 (custom), Vanilla JavaScript  
* **Machine Learning / Recs:**
  * LightFM 1.17 (hybrid collaborative filtering, installed from patched source)
  * scikit-learn (TF-IDF, cosine similarity, RAG index)
* **Explainable AI:**
  * Local LLM via [Ollama](https://ollama.com/) (e.g. Llama 3 / Llama 3.2)
  * Custom RAG implementation (TF-IDF + NearestNeighbors)
* **External APIs:** The Movie Database (TMDB) API  
* **Database:** SQLite (development), PostgreSQL/MySQL (production-ready)  
* **Environment:** `pyenv` + `virtualenv` (`.venv_310`)

> Note: Earlier versions used Conda and OpenRouter (Llama 3.3 70B). The current implementation uses **Python 3.10 + virtualenv** and a **local Ollama LLM**, which is reflected in the setup instructions below.

---

## 3. Project Structure

The current project (e.g. `MovieWise-XAI`) follows a modular Django structure:

```text
MovieWise-XAI/
├── .env                      # Environment variables (API keys, debug settings)
├── manage.py                 # Django's command-line utility
├── project/                  # Main Django project configuration
│   ├── settings.py           # Core Django settings
│   ├── urls.py               # Main URL router
│   └── asgi.py               # ASGI configuration
├── accounts/                 # User authentication and authorization
│   ├── forms.py              # Custom signup form
│   ├── views.py              # Signup and logout views
│   └── urls.py               # Account-specific URLs
├── core/                     # Core application models and services
│   ├── models.py             # Movie, Rating, UserOnboarding models
│   ├── admin.py              # Admin interface registration
│   └── services.py           # External service integrations (e.g., Ollama client)
├── recs/                     # Recommendation logic and APIs
│   ├── api_urls.py           # API endpoints for recommendations, ratings, explanations
│   ├── lightfm_pipeline.py   # LightFM model training, loading, and prediction logic
│   ├── serializers.py        # DRF serializers
│   ├── tmdb.py               # TMDB API client
│   └── views.py              # Rec & rating API views
├── rag/                      # Retrieval-Augmented Generation (RAG) functionality
│   ├── embeddings.py         # TF-IDF vectorization and NearestNeighbors store
│   ├── views.py              # RAG / explanation API view(s)
│   └── api_urls.py           # RAG-specific API URLs
├── ui/                       # User interface views and routing
│   ├── views.py              # Frontend views (main app, onboarding)
│   └── urls.py               # UI URLs
├── static/                   # Static assets
│   ├── app.css               # Custom CSS for styling and theme management
│   └── app.js                # Frontend JS logic and interactivity
└── templates/                # Django HTML templates
    ├── app.html              # Main single-page application template
    ├── layout.html           # Base template
    ├── onboarding.html       # Onboarding page
    └── registration/         # Auth templates
```

(Some directory names may differ slightly depending on your repo; adjust as needed.)

---

## 4. Setup and Installation

### Prerequisites

* **Python 3.10.14** (installed via `pyenv` recommended)  
* **pyenv** configured in `~/.zshrc`:

  ```zsh
  export PYENV_ROOT="$HOME/.pyenv"
  export PATH="$PYENV_ROOT/bin:$PATH"
  eval "$(pyenv init -)"
  ```

* **TMDB API Key:** Create a free API key at [TMDB](https://www.themoviedb.org/documentation/api).  
* **Ollama (for local LLM):** Install from [Ollama](https://ollama.com/) and pull a model, e.g.:

  ```bash
  ollama pull llama3.2
  ```

### Python & Virtualenv Setup (Recommended)

1. **Clone the repository:**

    ```bash
    git clone <repository_url> MovieWise-XAI
    cd MovieWise-XAI
    ```

2. **Set Python version via pyenv:**

    ```bash
    pyenv install 3.10.14   # if not already installed
    pyenv local 3.10.14
    ```

3. **Create and activate a virtual environment:**

    ```bash
    python -m venv .venv_310
    source .venv_310/bin/activate
    ```

4. **Install core dependencies:**

    ```bash
    pip install --upgrade pip
    pip install "numpy==1.23.5"
    pip install django djangorestframework joblib pandas scipy scikit-learn shap lime python-dotenv
    ```

5. **Install LightFM (patched from source, due to packaging bug):**

    ```bash
    # From the project root
    git clone https://github.com/lyst/lightfm.git lightfm_source
    cd lightfm_source

    # Checkout the 1.17 release
    git checkout 1.17

    # Patch setup.py to fix __LIGHTFM_SETUP__ error
    # If sed fails, open setup.py and edit manually.
    sed -i '' 's/__builtins__.__LIGHTFM_SETUP__/import builtins; builtins.__LIGHTFM_SETUP__/' setup.py

    # Install from this patched source
    pip install .
    ```

    Verify:

    ```bash
    pip show lightfm
    # Name: lightfm
    # Version: 1.17
    ```

6. **(Optional) Install from requirements file if present:**

    ```bash
    cd ..
    pip install -r requirements.txt
    ```

---

## 5. Configuration

The application uses a `.env` file for environment-specific settings.

1. Create a file named `.env` in the project root (or copy the example if present):

   ```bash
   cp .env.example .env   # if available
   ```

2. Add values (example):

   ```env
   DEBUG=1
   SECRET_KEY=your_django_secret_key_here
   ALLOWED_HOSTS=127.0.0.1,localhost

   TMDB_API_KEY=your_tmdb_api_key_here

   # Ollama / LLM config
   OLLAMA_URL=http://localhost:11434/api/generate
   OLLAMA_MODEL=llama3.2
   ```

Replace values appropriately.

---

## 6. Development Workflow

### Running the Server

1. **Activate your environment:**

    ```bash
    cd MovieWise-XAI
    source .venv_310/bin/activate
    ```

2. **Start the Django development server:**

    ```bash
    python manage.py runserver
    ```

    Access the application at `http://localhost:8000`.

### Database Migrations

Apply initial database migrations:

```bash
python manage.py migrate
```

### Creating a Superuser

Create an admin user to access the Django admin panel:

```bash
python manage.py createsuperuser
```

### Data Ingestion (TMDB)

Ingest initial movie data from TMDB (example: 3 pages of popular movies):

```bash
python manage.py tmdb_ingest --pages=3
```

(If your command or arguments differ, adjust accordingly.)

### Training Recommendation Model

Train the LightFM recommendation model. Run periodically as more user ratings are collected.

```bash
python manage.py train_lightfm
```

This will:

- Build the user–item interaction matrix.
- Train a LightFM model.
- Save artifacts (e.g. `models/lightfm_artifacts.pkl`).

---

## 7. Key API Endpoints

All API endpoints are located under `/api/`.

| Endpoint                   | Method | Description                                                                                       | Auth        | Example Usage                                           |
|---------------------------|--------|---------------------------------------------------------------------------------------------------|-------------|---------------------------------------------------------|
| `/discover/`              | GET    | Discover movies from TMDB based on filters (actor, genre, language).                             | Optional    | `/api/discover/?genre=action&lang=en`                   |
| `/ratings/`               | POST   | Submit/update a user rating for a movie (local ID or TMDB ID).                                   | Required    | Body: `{"movie": "1025527", "value": 5}`                |
| `/recommendations/`       | GET    | Personalized movie recommendations using **LightFM**; requires minimum number of ratings.        | Required    | `/api/recommendations/?k=12`                            |
| `/trending/`              | GET    | Real-time trending movies from TMDB's `/trending` endpoint.                                      | Optional    | `/api/trending/?k=12&time_window=day`                   |
| `/explain/`               | GET    | Basic rule-based explanation (legacy, superseded by `natural-explanation` in UI).                | Optional    | `/api/explain/?tmdb_id=1062722`                         |
| `/natural-explanation/`   | GET    | Natural language explanation using LLM + RAG for a given recommended movie.                      | Optional    | `/api/natural-explanation/?movie_id=123`                |
| `/onboarding/complete/`   | POST   | Marks the authenticated user's onboarding as complete.                                           | Required    | Body: `{}`                                              |
| `/user-ratings/`          | GET    | Fetches user's ratings for specified movies (by local ID or TMDB ID).                            | Required    | `/api/user-ratings/?movie_id=1&movie_id=2`              |
| `/rag/qa/`                | GET    | RAG-based question answering on movie content (titles + overviews).                             | Optional    | `/api/rag/qa/?q=sci-fi+movies+about+space`              |

---

## 8. User Flows

### User Onboarding

1. **Registration/Login:** User creates an account and logs in.  
2. **Redirection:** If onboarding is incomplete, user is redirected to the onboarding page.  
3. **Preference Collection:** User rates ~5–15 movies across genres to initialize preferences.  
4. **Completion:** Once threshold is met, "Complete Setup" button activates, calling `/api/onboarding/complete/`.  
5. **Main App Access:** User is redirected to the main app page; personalized recommendations become available.

### Personalized Recommendations (For You Section)

* Displays LightFM-powered recommendations tailored to the user.  
* Each card can have a "Why?" button, which triggers the explanation endpoint.  
* If the user has not rated enough items, UI shows a message prompting them to rate more.

### Movie Rating

* 5-star rating UI on all movie cards (For You, Trending, Search).  
* Pre-fills stars if the user has previously rated the movie.  
* Submits ratings via `POST /api/ratings/`.  
* Visual feedback and instant updates.

### Movie Search

* Search bar supports queries by actor, genre, language, etc.  
* Search results are TMDB-powered and displayed in a dedicated results section.  
* "Back to Home" restores the main recommendation and trending sections.

### Trailer Access

* "Trailer" button opens a modal with a link to a YouTube search for the movie's trailer.  

### Explainable AI

* "Why?" button on recommendation cards calls `/api/natural-explanation/`.  
* Backend:
  * Builds a small RAG index with candidate movies and user ratings.
  * Calls the Ollama LLM.
  * Returns a ~40-word explanation grounded in the user's preferences and movie attributes.
* Fallback logic ensures an explanation is returned even if LLM or RAG fails.

---

## 9. Frontend Details

* **Technologies:** Vanilla JavaScript + custom CSS.  
* **Dynamic UI:** Uses `fetch` calls to interact with REST APIs and update DOM sections dynamically.  
* **Theme Management:** Light/dark mode with CSS custom properties and preference persistence (e.g. `localStorage`).  
* **Interactive Elements:**  
  * Star rating widgets  
  * Explanation modals  
  * Search result panels and buttons  

---

## 10. Backend Details

* **Django REST Framework:** Provides JSON APIs for the frontend.  
* **Modular apps:** `accounts`, `core`, `recs`, `rag`, `ui` clearly separate concerns.  
* **TMDB Client (`recs/tmdb.py`):** Wraps TMDB HTTP requests with error handling, pagination, and caching (if used).  
* **Management Commands:**
  * `tmdb_ingest` – seeds the DB with TMDB movies.  
  * `train_lightfm` – trains and saves LightFM recommendation artifacts.

---

## 11. Explainable AI (XAI) Details

* **LightFM for Recommendations:**  
  Hybrid collaborative filtering using user–item interactions and movie features.

* **LLM for Explanations (via Ollama):**  
  Local LLM (e.g. Llama 3 / 3.2) generates natural language explanations.

* **RAG Pipeline:**  
  TF-IDF over movie titles/overviews + nearest-neighbor search to surface relevant context about the user's liked items and candidates.

* **Grounded Explanations:**  
  Prompts are constructed with:
  * User's rating history
  * Candidate movie metadata (genres, overview, popularity)
  * Similar/alternative movies  
  to ensure explanations are personalized and evidence-based.

---

## 12. Troubleshooting

* **Virtualenv / pyenv Issues:**
  * Ensure `pyenv local 3.10.14` is set in the project directory.
  * Activate the correct venv: `source .venv_310/bin/activate`.

* **LightFM Installation Errors (`__LIGHTFM_SETUP__`):**
  * Use the **patched source install** from the GitHub repo as described in [Setup](#python--virtualenv-setup-recommended).
  * Confirm with `pip show lightfm` that version 1.17 is installed.

* **TMDB API Key:**
  * Verify that `TMDB_API_KEY` is present and valid in `.env`.

* **Database Migrations:**
  * Run `python manage.py migrate` after pulling new changes or modifying models.

* **No Recommendations / Cold Start:**
  * Ensure the user has rated at least the minimum required movies.
  * Check that `python manage.py train_lightfm` has been run successfully.

* **LLM / Explanation Failures:**
  * Confirm Ollama is running: `curl http://localhost:11434/api/tags`.
  * Check `OLLAMA_URL` and `OLLAMA_MODEL` in `.env`.
  * Verify logs in the Django console for any errors when calling `/api/natural-explanation/`.

---

This README reflects the **current working setup**: Python 3.10 + virtualenv, LightFM 1.17 installed from patched source, TMDB for data, and a local Ollama LLM for natural-language explanations.
