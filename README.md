# MovieWise XAI - Personalized Movie Recommendations with Explainable AI

MovieWise XAI is a Django-based web application that provides personalized movie recommendations to users, enhanced with explainable AI (XAI) features and a rich, interactive user interface. The system leverages state-of-the-art machine learning models (LightFM) and large language models (Llama 3.3 70B via OpenRouter) to deliver a seamless and insightful movie discovery experience.

## Table of Contents

1.  [Features](#1-features)
2.  [Technology Stack](#2-technology-stack)
3.  [Project Structure](#3-project-structure)
4.  [Setup and Installation](#4-setup-and-installation)
    *   [Prerequisites](#prerequisites)
    *   [Conda Setup (Recommended)](#conda-setup-recommended)
    *   [Manual Setup (Virtualenv)](#manual-setup-virtualenv)
5.  [Configuration](#5-configuration)
6.  [Development Workflow](#6-development-workflow)
    *   [Running the Server](#running-the-server)
    *   [Database Migrations](#database-migrations)
    *   [Creating a Superuser](#creating-a-superuser)
    *   [Data Ingestion (TMDB)](#data-ingestion-tmdb)
    *   [Training Recommendation Model](#training-recommendation-model)
7.  [Key API Endpoints](#7-key-api-endpoints)
8.  [User Flows](#8-user-flows)
    *   [User Onboarding](#user-onboarding)
    *   [Personalized Recommendations](#personalized-recommendations)
    *   [Movie Rating](#movie-rating)
    *   [Movie Search](#movie-search)
    *   [Trailer Access](#trailer-access)
    *   [Explainable AI](#explainable-ai)
9.  [Frontend Details](#9-frontend-details)
10. [Backend Details](#10-backend-details)
11. [Explainable AI (XAI) Details](#11-explainable-ai-xai-details)
12. [Troubleshooting](#12-troubleshooting)

## 1. Features

*   **Personalized Recommendations:** Get movie suggestions tailored to your unique taste using LightFM.
*   **Explainable AI (XAI):** Understand *why* a movie is recommended with concise, natural language explanations generated by a Large Language Model (LLM).
*   **Real-time Trending:** Discover the latest popular movies directly from TMDB's dynamic feeds.
*   **Interactive Rating System:** Rate any movie with a 5-star system, providing instant feedback and influencing future recommendations.
*   **Guided Onboarding:** A smooth process for new users to quickly establish preferences and unlock personalized content.
*   **Robust Search & Discovery:** Find movies by actor, genre, or language, powered by TMDB.
*   **Trailer Access:** Easily access movie trailers via YouTube search.
*   **User Authentication:** Secure user registration and login.
*   **Dark/Light Mode:** Seamlessly switch between themes for comfortable viewing.

## 2. Technology Stack

*   **Backend:** Python 3.10+, Django 5.0+, Django REST Framework, Django Channels (for future real-time features).
*   **Frontend:** HTML5, CSS3 (Custom), Vanilla JavaScript, Bootstrap 5, Bootstrap Icons.
*   **Machine Learning:** LightFM (hybrid collaborative filtering), scikit-learn (TF-IDF, cosine similarity).
*   **Explainable AI:** OpenRouter API (Llama 3.3 70B model), custom RAG implementation.
*   **External APIs:** The Movie Database (TMDB) API.
*   **Database:** SQLite (development), PostgreSQL/MySQL (production).
*   **Environment:** Conda (recommended for development).

## 3. Project Structure

The project follows a modular Django application structure.

```
xai_recs_full_v3_2_auth_ui/
├── .env                      # Environment variables (API keys, debug settings)
├── manage.py                 # Django's command-line utility
├── project/                  # Main Django project configuration
│   ├── settings.py           # Core Django settings
│   ├── urls.py               # Main URL router
│   └── asgi.py               # ASGI configuration
├── accounts/                 # User authentication and authorization
│   ├── forms.py              # Custom signup form
│   ├── views.py              # Signup and logout views
│   └── urls.py               # Account-specific URLs
├── core/                     # Core application models and services
│   ├── models.py             # Movie, Rating, UserOnboarding models
│   ├── admin.py              # Admin interface registration
│   └── services.py           # External service integrations (e.g., OpenRouter)
├── recs/                     # Recommendation system logic and APIs
│   ├── api_urls.py           # API endpoints for recommendations, ratings, explanations
│   ├── lightfm_pipeline.py   # LightFM model training, loading, and prediction logic
│   ├── serializers.py        # Data serializers for Django REST Framework
│   ├── tmdb.py               # TMDB API client
│   └── views.py              # API view functions
├── rag/                      # Retrieval-Augmented Generation (RAG) functionality
│   ├── embeddings.py         # TF-IDF vectorization and NearestNeighbors store
│   ├── views.py              # RAG API view
│   └── api_urls.py           # RAG-specific API URLs
├── ui/                       # User interface views and routing
│   ├── views.py              # Frontend views (app, onboarding)
│   └── urls.py               # UI-specific URLs
├── static/                   # Static assets (CSS, JavaScript)
│   ├── app.css               # Custom CSS for styling and theme management
│   └── app.js                # Frontend JavaScript logic and interactivity
└── templates/                # Django HTML templates
    ├── app.html              # The main single-page application template
    ├── layout.html           # Base template
    ├── onboarding.html       # New user onboarding page
    └── registration/         # Authentication templates
```

## 4. Setup and Installation

### Prerequisites

*   **Miniconda or Anaconda:** Recommended for managing Python environments and dependencies. Download from [Miniconda](https://conda.io/miniconda.html).
*   **TMDB API Key:** Obtain a free API key from [The Movie Database (TMDB)](https://www.themoviedb.org/documentation/api).

### Conda Setup (Recommended)

1.  **Clone the repository:**
    ```bash
    git clone <repository_url>
    cd xai_recs_full_v3_2_auth_ui
    ```
2.  **Create and activate the Conda environment:**
    ```bash
    conda env create -f environment.yml
    conda activate xai-recs-django
    ```
3.  **Create a `.env` file:**
    Copy `.env.example` to `.env` and fill in your TMDB API key.
    ```bash
    cp .env.example .env
    # Open .env and add your TMDB_API_KEY
    ```

### Manual Setup (Virtualenv)

1.  **Create and activate a Python virtual environment:**
    ```bash
    python -m venv .venv
    # On Windows:
    .venv\Scripts\activate
    # On macOS/Linux:
    source .venv/bin/activate
    ```
2.  **Install dependencies:**
    ```bash
    pip install -r requirements.txt
    ```
3.  **Create a `.env` file:**
    Copy `.env.example` to `.env` and fill in your TMDB API key.
    ```bash
    cp .env.example .env
    # Open .env and add your TMDB_API_KEY
    ```

## 5. Configuration

The application uses a `.env` file for environment-specific settings.

*   Create a file named `.env` in the project root.
*   Add the following variables:
    ```
    DEBUG=1
    SECRET_KEY=your_django_secret_key_here
    ALLOWED_HOSTS=127.0.0.1,localhost
    TMDB_API_KEY=your_tmdb_api_key_here
    ```
    Replace `your_django_secret_key_here` with a strong, unique key and `your_tmdb_api_key_here` with your actual TMDB API key.

## 6. Development Workflow

### Running the Server

1.  **Activate your environment:**
    ```bash
    conda activate xai-recs-django
    # or if using virtualenv:
    # .venv\Scripts\activate
    ```
2.  **Start the Django development server:**
    ```bash
    python manage.py runserver
    ```
    Access the application at `http://localhost:8000`.

### Database Migrations

Apply initial database migrations:
```bash
python manage.py migrate
```

### Creating a Superuser

Create an admin user to access the Django admin panel:
```bash
python manage.py createsuperuser
```

### Data Ingestion (TMDB)

Ingest initial movie data from TMDB (e.g., 3 pages of popular movies):
```bash
python manage.py tmdb_ingest --pages=3
```

### Training Recommendation Model

Train the LightFM recommendation model. This should be run periodically as more user ratings are collected.
```bash
python manage.py train_lightfm
```

## 7. Key API Endpoints

All API endpoints are located under `/api/`.

| Endpoint | Method | Description | Authentication | Example Usage |
| :------- | :----- | :---------- | :------------- | :------------ |
| `/discover/` | GET | Discovers movies from TMDB based on filters (actor, genre, language). | Optional | `/api/discover/?genre=action&lang=en` |
| `/ratings/` | POST | Submits a user rating for a movie. Handles both local Movie IDs and TMDB IDs. | Required | Body: `{"movie": "1025527", "value": 5}` |
| `/recommendations/` | GET | Returns personalized movie recommendations for the authenticated user (LightFM-powered). Requires a minimum of 5 ratings. | Required | `/api/recommendations/?k=12` |
| `/trending/` | GET | Fetches real-time trending movies directly from TMDB's `/trending` endpoint. | Optional | `/api/trending/?k=12&time_window=day` |
| `/explain/` | GET | Provides a basic explanation for a movie based on TMDB rating and popularity. (Legacy, superseded by `natural-explanation`). | Optional | `/api/explain/?tmdb_id=1062722` |
| `/natural-explanation/` | GET | Generates a natural language explanation for a movie recommendation using an LLM (Llama 3.3 70B), with RAG and simple fallbacks. | Optional | `/api/natural-explanation/?movie_id=123` |
| `/onboarding/complete/` | POST | Marks the authenticated user's onboarding process as complete. | Required | Body: `{}` |
| `/user-ratings/` | GET | Fetches an authenticated user's ratings for a list of specified movies (by local ID or TMDB ID). | Required | `/api/user-ratings/?movie_id=1&movie_id=2` |
| `/rag/qa/` | GET | Performs RAG-based question answering on movie content (titles and overviews). | Optional | `/api/rag/qa/?q=sci-fi+movies+about+space` |

## 8. User Flows

### User Onboarding

1.  **Registration/Login:** A new user creates an account and logs in.
2.  **Redirection:** If onboarding is not complete, the user is redirected to the dedicated onboarding page.
3.  **Preference Collection:** Users rate 5-15 movies across genres to establish initial preferences.
4.  **Completion:** Once the minimum rating threshold (5 movies) is met, the "Complete Setup" button activates. Clicking it marks onboarding as complete via `/api/onboarding/complete/`.
5.  **Main App Access:** User is redirected to the main application page, where personalized recommendations become available.

### Personalized Recommendations (For You Section)

*   Displays movies tailored to the user's taste, primarily generated by the LightFM model.
*   Features a "Why?" button on each card, providing a concise, LLM-generated explanation.
*   If insufficient ratings, a progress message guides the user to rate more movies.

### Movie Rating

*   Interactive 5-star rating system on every movie card (For You, Trending, Search).
*   Pre-fills stars if a movie has been previously rated.
*   Submits ratings via `POST /api/ratings/`.
*   Provides instant visual feedback on the card and a modal confirmation.
*   Ratings are saved and used by LightFM for future model training.

### Movie Search

*   Search bar allows queries by actor, genre, or language.
*   Initiating a search dynamically replaces the main homepage content with a dedicated "Search Results" section.
*   Results are TMDB-powered and displayed without "Why?" buttons.
*   A "Back to Home" button restores the original homepage content.

### Trailer Access

*   "Trailer" button on movie cards opens a new modal.
*   A button within the modal directs the user to a YouTube search page in a new tab for the movie's official trailer.

### Explainable AI

*   The "Why?" button on personalized recommendation cards triggers a call to `/api/natural-explanation/`.
*   An LLM (Llama 3.3 70B) generates a ~40-word natural language explanation, grounded in user preferences and movie attributes.
*   A robust fallback system ensures an explanation is always provided (LLM -> RAG -> Simple).

## 9. Frontend Details

*   **Technologies:** Vanilla JavaScript, Bootstrap 5, Bootstrap Icons.
*   **Dynamic UI:** Uses JavaScript to fetch data asynchronously and dynamically update content sections (e.g., replacing homepage content with search results).
*   **Theme Management:** Robust light/dark mode toggle using CSS custom properties and Bootstrap Icons, with preference persistence in `localStorage`.
*   **Interactive Elements:** Custom JavaScript for star rating interactions, button wiring, and modal management.

## 10. Backend Details

*   **Django REST Framework:** Provides the RESTful API endpoints for the frontend.
*   **Modular Design:** Applications (`accounts`, `core`, `recs`, `rag`, `ui`) are logically separated.
*   **TMDB Client (`recs/tmdb.py`):** Handles all interactions with the TMDB API, including retries and error handling.
*   **Management Commands:** Custom Django management commands (`tmdb_ingest`, `train_lightfm`) for data seeding and model training.

## 11. Explainable AI (XAI) Details

*   **LightFM for Recommendations:** Utilizes a hybrid collaborative filtering model.
*   **LLM for Explanations:** OpenRouter's Llama 3.3 70B is used for generating natural language explanations.
*   **RAG Fallback:** A custom RAG implementation (TF-IDF + NearestNeighbors) provides content-based explanations as a fallback when the LLM is unavailable or fails.
*   **Grounded Explanations:** LLM prompts are carefully constructed with user's specific rating history and movie details to ensure explanations are relevant and personalized.

## 12. Troubleshooting

*   **Conda Environment Issues:** Ensure your Conda environment is correctly activated. Use `conda clean --all` and recreate if conflicts arise.
*   **TMDB API Key:** Verify `TMDB_API_KEY` in your `.env` file is correct and active.
*   **Database Migrations:** Always run `python manage.py migrate` after pulling new changes or modifying models.
*   **LightFM Model:** Ensure `python manage.py train_lightfm` has been run to train the recommendation model.