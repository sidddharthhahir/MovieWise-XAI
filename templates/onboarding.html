{% extends 'layout.html' %}
{% block title %}Setup Your Movie Preferences{% endblock %}

{% block body %}
<div class="container py-4">
  <!-- Header -->
  <div class="text-center mb-4">
    <h1 class="display-5 fw-bold">Welcome to MovieWise! üé¨</h1>
    <p class="lead text-muted">Help us understand your taste by rating a few movies from each genre.</p>
  </div>

  <!-- Progress Bar -->
  <div class="card mb-4">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h6 class="mb-0">Your Progress</h6>
        <span class="badge bg-primary" id="progressCount">0/12</span>
      </div>
      <div class="progress" style="height: 8px;">
        <div id="progressBar" class="progress-bar" role="progressbar" 
             style="width: 0%; background-color: #0d6efd;"
             aria-valuenow="0" aria-valuemin="0" aria-valuemax="12">
        </div>
      </div>
      <small class="text-muted">Rate at least 3 movies from each genre to continue</small>
    </div>
  </div>

  <!-- Genre Sections -->
  <div class="row">
    <!-- Action Movies -->
    <div class="col-12 mb-4">
      <h4 class="mb-3">üî• Action Movies</h4>
      <div id="actionGrid" class="row g-3">
        <div class="col-12 text-center py-4">
          <div class="spinner-border text-primary"></div>
          <div class="mt-2">Loading action movies...</div>
        </div>
      </div>
    </div>

    <!-- Drama Movies -->
    <div class="col-12 mb-4">
      <h4 class="mb-3">üé≠ Drama Movies</h4>
      <div id="dramaGrid" class="row g-3">
        <div class="col-12 text-center py-4">
          <div class="spinner-border text-primary"></div>
          <div class="mt-2">Loading drama movies...</div>
        </div>
      </div>
    </div>

    <!-- Comedy Movies -->
    <div class="col-12 mb-4">
      <h4 class="mb-3">üòÑ Comedy Movies</h4>
      <div id="comedyGrid" class="row g-3">
        <div class="col-12 text-center py-4">
          <div class="spinner-border text-primary"></div>
          <div class="mt-2">Loading comedy movies...</div>
        </div>
      </div>
    </div>

    <!-- Romance Movies -->
    <div class="col-12 mb-4">
      <h4 class="mb-3">üíï Romance Movies</h4>
      <div id="romanceGrid" class="row g-3">
        <div class="col-12 text-center py-4">
          <div class="spinner-border text-primary"></div>
          <div class="mt-2">Loading romance movies...</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Complete Button -->
  <div class="text-center mt-4">
    <button id="completeOnboarding" class="btn btn-success btn-lg" disabled>
      <i class="bi bi-check-circle"></i> Complete Setup & Go to Recommendations
    </button>
    <div class="mt-2">
      <small class="text-muted" id="onboardingMessage">Rate more movies to unlock recommendations</small>
    </div>
  </div>
</div>

<!-- Rating Modal -->
<div class="modal fade" id="ratingModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="ratingModalTitle">Rate This Movie</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="ratingModalBody">
        <div id="modalMovie" class="text-center mb-3">
          <!-- Movie details will be loaded here -->
        </div>
        <div class="text-center">
          <div class="star-rating-large" id="modalStarRating">
            <!-- Interactive star rating will be loaded here -->
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="saveRating">Save Rating</button>
      </div>
    </div>
  </div>
</div>

<script>
  // Onboarding specific JavaScript
  const genreGrids = {
    'action': document.getElementById('actionGrid'),
    'drama': document.getElementById('dramaGrid'),
    'comedy': document.getElementById('comedyGrid'),
    'romance': document.getElementById('romanceGrid')
  };

  let progressCount = 0;
  let currentMovieId = null;
  let currentRating = 0;
  let currentGenre = '';

  // Load movies for each genre
  const genres = ['action', 'drama', 'comedy', 'romance'];
  genres.forEach(genre => loadGenreMovies(genre));

  async function loadGenreMovies(genre) {
    try {
      const response = await fetch(`/api/discover/?genre=${genre}&k=3`);
      const data = await response.json();
      const movies = data.results || [];
      
      genreGrids[genre].innerHTML = '';
      movies.forEach(movie => {
        genreGrids[genre].appendChild(createOnboardingCard(movie, genre));
      });
    } catch (error) {
      console.error(`Error loading ${genre} movies:`, error);
      genreGrids[genre].innerHTML = `<div class="col-12 text-center text-muted py-3">Failed to load ${genre} movies</div>`;
    }
  }

  function createOnboardingCard(movie, genre) {
    const col = document.createElement('div');
    col.className = 'col-12 col-md-6 col-lg-4';
    
    const poster = movie.poster || 'https://via.placeholder.com/300x450?text=No+Poster';
    
    col.innerHTML = `
      <div class="card card-movie h-100">
        <img src="${poster}" class="poster" alt="${movie.title}" onerror="this.src='https://via.placeholder.com/300x450?text=No+Poster'"/>
        <div class="p-3 d-flex flex-column">
          <div class="fw-semibold mb-1 text-truncate" title="${movie.title}">${movie.title}</div>
          <div class="small text-muted mb-2">‚≠ê ${movie.vote ?? '-'} ¬∑ ${movie.year ?? ''}</div>
          <div class="mt-auto">
            <button class="btn btn-primary w-100" onclick="openRatingModal('${movie.tmdb_id}', '${movie.title}', '${movie.vote || 0}', '${movie.popularity || 0}', '${poster}', '${genre}')">
              <i class="bi bi-star"></i> Rate This Movie
            </button>
          </div>
        </div>
      </div>
    `;
    
    return col;
  }

  function openRatingModal(tmdbId, title, vote, popularity, poster, genre) {
    currentMovieId = tmdbId;
    currentRating = 0;
    currentGenre = genre;
    
    document.getElementById('ratingModalTitle').textContent = `Rate: ${title}`;
    document.getElementById('modalMovie').innerHTML = `
      <img src="${poster}" class="img-fluid rounded mb-3" style="max-height: 200px;" onerror="this.style.display='none'">
      <p class="text-muted">‚≠ê ${vote}/10 ‚Ä¢ Click stars below to rate</p>
    `;
    
    // Create interactive star rating
    const starRating = document.getElementById('modalStarRating');
    starRating.innerHTML = '';
    for (let i = 1; i <= 5; i++) {
      const star = document.createElement('span');
      star.className = 'star-large';
      star.dataset.rating = i;
      star.innerHTML = '‚òÖ';
      star.style.cssText = 'font-size: 2rem; color: #ddd; cursor: pointer; margin: 0 5px; transition: color 0.2s;';
      star.addEventListener('mouseenter', () => highlightModalStars(i));
      star.addEventListener('mouseleave', () => highlightModalStars(currentRating));
      star.addEventListener('click', () => setModalRating(i));
      starRating.appendChild(star);
    }
    
    const modal = new bootstrap.Modal(document.getElementById('ratingModal'));
    modal.show();
  }

  function highlightModalStars(rating) {
    const stars = document.querySelectorAll('#modalStarRating .star-large');
    stars.forEach((star, index) => {
      star.style.color = index < rating ? '#ffc107' : '#ddd';
    });
  }

  function setModalRating(rating) {
    currentRating = rating;
    highlightModalStars(rating);
  }

  document.getElementById('saveRating').addEventListener('click', async () => {
    if (currentRating === 0) {
      alert('Please select a rating before saving');
      return;
    }
    
    try {
      // First, get or create the movie in our local database
      const createResponse = await fetch('/api/ratings/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
          movie: currentMovieId, // This will be the TMDB ID for onboarding
          value: currentRating
        })
      });
      
      if (createResponse.ok) {
        progressCount++;
        updateProgress();
        bootstrap.Modal.getInstance(document.getElementById('ratingModal')).hide();
        
        // Update the button to show it was rated
        const genre = currentGenre;
        const allButtons = document.querySelectorAll(`#${genre}Grid .btn`);
        for (let btn of allButtons) {
          if (btn.textContent.includes('Rate This Movie')) {
            btn.innerHTML = '<i class="bi bi-check-circle"></i> Rated!';
            btn.disabled = true;
            btn.className = 'btn btn-success w-100';
            break;
          }
        }
      } else {
        throw new Error('Failed to save rating');
      }
    } catch (error) {
      console.error('Error saving rating:', error);
      alert('Failed to save rating. Please try again.');
    }
  });

  function updateProgress() {
    const progressBar = document.getElementById('progressBar');
    const progressCountElement = document.getElementById('progressCount');
    const completeButton = document.getElementById('completeOnboarding');
    const message = document.getElementById('onboardingMessage');
    
    const percentage = (progressCount / 12) * 100;
    progressBar.style.width = `${percentage}%`;
    progressBar.setAttribute('aria-valuenow', progressCount);
    progressCountElement.textContent = `${progressCount}/12`;
    
    if (progressCount >= 5) {
      completeButton.disabled = false;
      message.textContent = 'Great! You can now access personalized recommendations';
      message.className = 'text-success';
      completeButton.className = 'btn btn-success btn-lg';
    } else {
      completeButton.disabled = true;
      const remaining = 5 - progressCount;
      message.textContent = `Rate ${remaining} more movie${remaining !== 1 ? 's' : ''} to unlock recommendations`;
      message.className = 'text-muted';
      completeButton.className = 'btn btn-secondary btn-lg';
    }
  }

  // Complete onboarding
  document.getElementById('completeOnboarding').addEventListener('click', async () => {
    try {
      const response = await fetch('/api/onboarding/complete/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken')
        }
      });
      
      if (response.ok) {
        window.location.href = '/';
      } else {
        alert('Failed to complete onboarding. Please try again.');
      }
    } catch (error) {
      console.error('Error completing onboarding:', error);
      alert('Failed to complete onboarding. Please try again.');
    }
  });

  // Initialize progress
  updateProgress();
</script>

<style>
  .star-large {
    font-size: 2rem;
    color: #ddd;
    cursor: pointer;
    margin: 0 5px;
    transition: color 0.2s;
  }
  
  .star-large:hover {
    color: #ffc107;
  }
</style>
{% endblock %}